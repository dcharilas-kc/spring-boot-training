**Exercise 9: Database migrations (Flyway)**

If you are not interested in learning more about Flyway, feel free to skip this exercise, as it is not required by the ones that follow.

All the below steps are meant for `caller-service`.

| Step | Actions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| a    | Add JPA libraries to the project and update configuration accordingly, as in `user-service`. Change default JPA behavior so that tables are NOT created automatically (you can do this by setting `ddl-auto` to `none`, as in https://stackoverflow.com/questions/21968965/disable-table-recreation-in-spring-boot-application).                                                                                                                                                                                |
| b    | Add Flyway libraries to enable database migrations (see https://www.baeldung.com/database-migrations-with-flyway). Add Flyway properties in `application.yml` or `application.properties`. You many use the DB as in `user-service` for simplicity reasons (ideally with a different schema). You will need to define `flyway.url`, `flyway.schemas`, `flyway.user`, `flyway.password`. <br/>Deploy the service and verify that table `flyway_schema_history` is automatically created in DB before proceeding. |
| c    | Create file `V1__create_audit_table.sql` under path `/src/main/resources/db/migration`. Write in it a script that creates table `REQUEST_AUDIT`, having columns `ID`, `TIMESTAMP`, `RESPONSE`. All names need to be exactly as shown here.                                                                                                                                                                                                                                                                      |
| d    | Create `RequestAudit` class under `package` domain. Use JPA annotations so that it is proper mapped to table `REQUEST_AUDIT`. <br/>Deploy the service and verify that a) table `REQUEST_AUDIT` is successfully created b) a record has been inserted in table `flyway_schema_history`.                                                                                                                                                                                                                          |
| e    | Whenever `caller-service` calls `user-service`, write a record in `REQUEST_AUDIT`, using a JPA repository. The result of the call should be stored as a JSON string in the `RESPONSE` column. Verify manually that this works as expected.                                                                                                                                                                                                                                                                      |
| f    | Add a new migration script under path `/src/main/resources/db/migration`, respecting the Flyway naming guidelines. Inside it add scripts that update table `REQUEST_AUDIT` by a) adding column `REQ_PROTOCOL` and b) renaming column `RESPONSE` to `RESPONSE_PAYLOAD`.                                                                                                                                                                                                                                          |          
| g    | Whenever a new record is being added to `REQUEST_AUDIT`, column `REQ_PROTOCOL` should be filled with value `REST`. Deploy the service and verify that these changes are applied successfully. Verify that table `flyway_schema_history` now has 2 rows.                                                                                                                                                                                                                                                         |

